import frappe
import math

def run_migration():
    \"\"\"Backfill Monthly Billing Ledger from Monthly Revenue Ledger (best-effort).\n+\n+    Also creates a DB unique index on Razorpay Webhook Log.event_id if not present.\n+    \"\"\"\n+    # Backfill ledgers\n+    rows = frappe.get_all(\"Monthly Revenue Ledger\", fields=[\"name\", \"restaurant\", \"month\", \"total_platform_fee\", \"total_gmv\"]) or []\n+    created = 0\n+    for r in rows:\n+        billing_month = r.get(\"month\")\n+        restaurant = r.get(\"restaurant\")\n+        # compute total_gmv if present\n+        total_gmv = int(r.get(\"total_gmv\") or 0)\n+        calculated_fee = int(math.floor(total_gmv * 0.01))\n+        min_amt = 999 * 100\n+        max_amt = 3999 * 100\n+        final_amount = max(min_amt, min(calculated_fee, max_amt))\n+        # create ledger if not exists\n+        if not frappe.db.exists(\"Monthly Billing Ledger\", {\"restaurant\": restaurant, \"billing_month\": billing_month}):\n+            doc = frappe.get_doc({\n+                \"doctype\": \"Monthly Billing Ledger\",\n+                \"restaurant\": restaurant,\n+                \"billing_month\": billing_month,\n+                \"total_gmv\": total_gmv,\n+                \"calculated_fee\": calculated_fee,\n+                \"final_amount\": final_amount,\n+                \"payment_status\": \"pending\"\n+            })\n+            doc.insert(ignore_permissions=True)\n+            created += 1\n+\n+    # Create unique index on Razorpay Webhook Log.event_id\n+    try:\n+        frappe.db.sql(\"ALTER TABLE `tabRazorpay Webhook Log` ADD UNIQUE INDEX ux_rzp_event_id (event_id(191))\")\n+    except Exception:\n+        # index may already exist or table missing - ignore\n+        pass\n+\n+    return {\"created_ledgers\": created}\n+\n*** End Patch**"}}
